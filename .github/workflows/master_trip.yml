name: Build and deploy PHP app to Azure Web App - Trip

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          tools: composer

      - name: Composer install
        run: |
          composer validate --no-check-publish
          composer install --prefer-dist --no-progress --no-interaction --optimize-autoloader

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: php-app
          path: .

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: php-app
          path: .

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_D564056D927D452E843D2A7A0AE9488D }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_A9F8386F60E141FA910EEA2F896499AF }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_E3FC7B552C4C437B806DC915921927A9 }}

      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'Trip'
          slot-name: 'Production'
          package: .

      # ←←← THE IMPORTANT PART STARTS HERE ←←←
      - name: Create Laravel directories + permissions + storage link on Azure (after deploy)
        uses: azure/cli@v2
        with:
          azcliversion: 2.66.0
          inlineScript: |
            echo "Creating Laravel directories on the live Azure server..."
            app_dir="/home/site/wwwroot"
            
            # Create all required Laravel folders
            mkdir -p $app_dir/storage/app/public
            mkdir -p $app_dir/storage/framework/cache/data
            mkdir -p $app_dir/storage/framework/sessions
            mkdir -p $app_dir/storage/framework/views
            mkdir -p $app_dir/storage/logs
            mkdir -p $app_dir/bootstrap/cache

            # Set correct permissions
            chmod -R 775 $app_dir/storage
            chmod -R 775 $app_dir/bootstrap/cache

            # Create storage symlink (important for asset URLs)
            cd $app_dir
            php artisan storage:link || true

            # Optional: clear + cache config/routes/views (makes app boot faster)
            php artisan config:cache || true
            php artisan route:cache || true
            php artisan view:cache || true

            echo "Laravel directories created and permissions fixed!"
